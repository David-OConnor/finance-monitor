{% extends 'base.html'  %}

{% block head_contents %}
    <title>Finance Monitor: Spending</title>
{% endblock %}

{% block contents %}
    <div class="home-body">
        <div style="display: flex; align-items: center; flex-wrap: wrap;">

            <h2 style="margin-right: 20px;">Past <span id="days-back">30</span> days</h2>
            {#            <form method="post" style="display: flex; align-items: center;">#}
            {#                {% csrf_token %}#}
            <button id="range-30" class="button-general" onclick="setRange(30)">Past 30 days</button>
            <button id="range-60" class="button-general" onclick="setRange(60)">Past 60 days</button>
            <button id="range-90" class="button-general" onclick="setRange(90)">Past 90 days</button>
            <button id="range-custom" class="button-general" onclick="setRange(-1)">Custom:</button>

            <h3 style="margin-right: 6px;">Start:</h3>
            <input id="start" type="date" />
            <h3 style="margin-left: 12px; margin-right: 6px;">End:</h3>
            <input id="end" type="date" />
            {#            </form>#}
        </div>


        <div style="display: flex; justify-content: center;">
            {#            <h2 style="margin-right: 40px;">Income: <span  id="income-total">{{ income_total|floatformat:"0g" }}</span></h2>#}
            <h2 style="margin-right: 40px;">Income: <span id="income-total" class="tran-pos"></span></h2>
            {#            <h2>Expenses: <span id="expenses-total">{{ expenses_total|floatformat:"0g" }}</span></h2>#}
            <h2>Expenses: <span id="expenses-total" class="tran-neg"></span></h2>
        </div>

        <div style="display: flex; justify-content: center; flex-wrap: wrap;">
            <div id="plot-wrapper" style="width: 460px; margin-bottom: 40px;">
                <canvas id="plot"></canvas>
            </div>


            {#        <div style="display: flex; justify-content: space-evenly">#}

            <div style="display: flex; flex-direction: column; margin-left: 80px; margin-right: 80px;">
                <h2>Spending</h2>
                <div id="spending-section">
                    {#                    {% for highlight in highlights.by_cat %}#}
                    {#                        <h4 style="margin-top: 0; margin-bottom: 0;">{{ highlight.0 }}: <span>{{ highlight.1.1|floatformat:"0g" }}</span></h4>#}
                    {#                    {% endfor %}#}
                </div>
            </div>

            <div style="display: flex; flex-direction: column; margin-right: 80px;">
                <h2>Changes</h2>
                <div id="change-section">
                    {#                    {% for change in highlights.cat_changes %}#}
                    {#                        <h4 style="margin-top: 0; margin-bottom: 0;">{{ change.0 }}: <span>{{ change.1|floatformat:"0g" }}</span></h4>#}
                    {#                    {% endfor %}#}
                </div>
            </div>

            <div style="display: flex; flex-direction: column;">
                <h2>New merchants</h2>
                <div id="new-merchants-section">
                    {#                    {% for change in highlights.cat_changes %}#}
                    {#                        <h4 style="margin-top: 0; margin-bottom: 0;">{{ change.0 }}: <span>{{ change.1|floatformat:"0g" }}</span></h4>#}
                    {#                    {% endfor %}#}
                </div>
            </div>
        </div>


        <div style="display: flex; flex-wrap: wrap; justify-content: center; margin-top: 60px;">
            <div style="display: flex; margin-top: 20px; margin-right: 60px; align-items:  center; flex-direction: column">
                <h2>Spending over time</h2>

                <div id="spending-over-time-wrapper" style="width: 500px; margin-bottom: 40px;">
                    <canvas id="spending-over-time"></canvas>
                </div>
            </div>

            <div style="display: flex; margin-top: 20px; align-items:  center; flex-direction: column">
                <h2>Net income over time</h2>

                <div id="income-over-time-wrapper" style="width: 500px; margin-bottom: 40px;">
                    <canvas id="income-over-time"></canvas>
                </div>
            </div>
        </div>

    </div>

    <script src="../static/util.js"></script>


    {#    <script src=" https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js "></script>#}
    <script src="../static/js_libs/chart.min.js"></script>
    <script src="../static/js_libs/chartjs-plugin-datalabels-220.min.js"></script>
    {#    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>#}

    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js" charset="utf-8"></script>

    {#     todo: Experimenting, for labels on teh plot #}
    <!-- Include after Chart.js script -->

    {#    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>#}


    <script>
        getEl("menu-spending").classList.add("menu-highlighted")

        {# Load template variables into JS. #}

        {#let HIGHLIGHTS = {{ highlights|safe }};#}
        {#let INCOME_TOTAL = {{ income_total|safe }};#}
        {#let EXPENSES_TOTAL = {{ expenses_total|safe }};#}
        let CUSTOM_CATEGORIES = {{custom_categories|safe }};

        let HIGHLIGHTS = {by_cat: []}
        let INCOME_TOTAL = 0
        let EXPENSES_TOTAL = 0
        let SPENDING_OVER_TIME = []
        let INCOME_OVER_TIME = []
        let merchants_new = []

        let LOOKBACK = 30

        // If we overrun this color list, it loops back to the top.
        const PLOT_COLORS = [
            'rgb(255, 99, 132)',
            'rgb(54, 162, 235)',
            'rgb(187,255,86)',
            'rgb(86,255,255)',
            'rgb(199,86,255)',
            'rgb(255,137,86)',
            'rgb(255,86,227)',
            'rgb(86,255,204)',
            //
            'rgb(180,71,95)',
            'rgb(36,110,161)',
            'rgb(117,157,54)',
            'rgb(55,166,166)',
            'rgb(131,55,164)',
            'rgb(150,82,51)',
            'rgb(169,56,150)',
            'rgb(52,168,133)',

        ]

        function setRange(daysBack) {
            // Set the date range.

            let activeColor = "#349614"
            let activeWeight = "bold"

            let activeBtn
            let inactiveBtns = []
            if (daysBack === 30) {
                activeBtn = getEl("range-30")
                inactiveBtns = [
                    getEl("range-60"),
                    getEl("range-90"),
                    getEl("range-custom"),
                ]
            } else if (daysBack === 60) {
                activeBtn = getEl("range-60")
                inactiveBtns = [
                    getEl("range-30"),
                    getEl("range-90"),
                    getEl("range-custom"),
                ]
            } else if (daysBack === 90) {
                activeBtn = getEl("range-90")
                inactiveBtns = [
                    getEl("range-30"),
                    getEl("range-60"),
                    getEl("range-custom"),
                ]
            } else if (daysBack === -1) {
                activeBtn = getEl("range-custom")
                inactiveBtns = [
                    getEl("range-30"),
                    getEl("range-60"),
                    getEl("range-90"),
                ]
            }

            activeBtn.style.color = activeColor
            activeBtn.style.borderColor = activeColor
            activeBtn.style.fontWeight = activeWeight

            for (let btn of inactiveBtns) {
                btn.style.color = null
                btn.style.borderColor = null
                btn.style.fontWeight = null
            }

            LOOKBACK = daysBack
            if (daysBack === -1) {
                getEl("days-back").textContent = "(Custom)"
            } else {
                getEl("days-back").textContent = daysBack.toString()
            }


            let start, end
            if (daysBack === -1) {
                // auto
                const startDate = getEl("start").value
                const endDate = getEl("end").value
                start = parseInt((new Date() - new Date(startDate)) / (3600 * 1000*24))
                end = parseInt((new Date() - new Date(endDate)) / (3600 * 1000*24))
            } else {
                end = 0
                start = daysBack
            }

            const payload = {
                start: start,
                end: end,
            }

            fetch("/load-spending-data", { body: JSON.stringify(payload), ...FETCH_HEADERS_POST })
                .then(result => result.json())
                .then(r => {
                    HIGHLIGHTS = r.highlights
                    INCOME_TOTAL = r.income_total
                    EXPENSES_TOTAL = r.expenses_total
                    SPENDING_OVER_TIME = r.spending_over_time
                    INCOME_OVER_TIME = r.income_over_time
                    MERCHANTS_NEW = r.merchants_new

                    LOOKBACK = daysBack

                    getEl("income-total").textContent = formatAmount(INCOME_TOTAL, 0)
                    getEl("expenses-total").textContent = formatAmount(-EXPENSES_TOTAL, 0)

                    populate()
                    setupPieCharts()
                    setupTrendCharts()
                });
        }

        function populate() {
            let sectionSpending = getEl("spending-section")
            sectionSpending.replaceChildren()

            for (let item of HIGHLIGHTS.by_cat) {
                let amountText = formatAmount(item[1][1])
                amountText = amountText.replace("-", "")

                let h4 = createEl("h4", {}, {marginTop: 0, marginBottom: 0, fontWeight: "normal"}, catDisp(item[0]) + ": ")
                let s = createEl("span", {class: "tran-neutral"},  {}, amountText)
                h4.appendChild(s)
                sectionSpending.appendChild(h4)
            }

            let sectionChanges = getEl("change-section")
            sectionChanges.replaceChildren()
            for (let item of HIGHLIGHTS.cat_changes) {
                let amountText = formatAmount(item[1])
                if (item[1] > 0) {
                    amountText = "+" + amountText
                }

                let h4 = createEl("h4", {}, {marginTop: 0, marginBottom: 0, fontWeight: "normal"}, catDisp(item[0]) + ": ")
                let s = createEl("span", {class: "tran-neutral"},  {}, amountText)
                h4.appendChild(s)
                sectionChanges.appendChild(h4)
            }

            let newMerchants = getEl("new-merchants-section")
            newMerchants .replaceChildren()

            let h4
            if (MERCHANTS_NEW.length === 0 ) {
                h4 = createEl("h4", {}, {marginTop: 0, marginBottom: 0, fontWeight: "normal"}, "(None)")
                newMerchants.appendChild(h4)
            }

            for (let merchant of MERCHANTS_NEW) {
                h4 = createEl("h4", {}, {marginTop: 0, marginBottom: 0, fontWeight: "normal", marginLeft: "6px"}, merchant[0])
                console.log(merchant)
                if (merchant[1] !== null && merchant[1].length !== 0) {
                    let d = createEl("div", {}, {display: "flex"})
                    let img = createEl("img", {"src": merchant[1], alt: "", width: "24px"})
                    d.appendChild(img)
                    d.appendChild(h4)
                    newMerchants.appendChild(d)
                } else {
                    newMerchants.appendChild(h4)
                }
            }

        }

        function updateData() {

        }

        function setupPieCharts() {
            // https://www.chartjs.org/docs/latest/charts/doughnut.html#doughnut

            {#const config = {#}
            {#    type: 'doughnut',#}
            {#    data: data,#}

            const PCT_THRESH_GROUP = 0.07
            // todo:  YOu could use the alreayd passed income.
            // todo: Misc cat
            let total = 0
            for (let item of HIGHLIGHTS.by_cat) {
                total += item[1][1]
            }

            // Group minor contributors together.
            let labels = []
            let values = []
            let minorTotal = 0.
            for (let item of HIGHLIGHTS.by_cat) {
                let port = item[1][1] / total
                if (port > PCT_THRESH_GROUP) {
                    labels.push(catDisp(item[0]))
                    values.push(-item[1][1])
                } else {
                    minorTotal += -item[1][1]
                }
            }
            labels.push("Other")
            values.push(minorTotal)



            {#for (let item of HIGHLIGHTS.by_cat) {#}
            {#    labels.push(catDisp(item[0]))#}
            {#    values.push(item[1][1])#}
            //    {#}#}

            getEl('plot').remove()

            let data_ = [{
                values: values,
                labels: labels,
                type: 'pie',
                textinfo: "label",
            }];

            let layout = {
                height: 480,
                width: 480,
                showlegend: false,
                // backgroundColor: "black"
                {#plot_bgcolor:"black",#}
                paper_bgcolor: "#F8F8F8",
                // todo: How do we reduce the margins?
            };

            Plotly.newPlot('plot-wrapper', data_, layout, {displaylogo: false});



            return


            let el = document.createElement("canvas")
            el.setAttribute("id", "plot")

            document.addEventListener('DOMContentLoaded', function () {
                var ctx = document.getElementById('myPieChart').getContext('2d');
                // Your chart initialization code here
            });
            getEl("plot-wrapper").appendChild(el)

            let chartArea = getEl('plot').getContext('2d')

            const data = {
                labels: labels,
                datasets: [{
                    {#label: "Spending, by category",#}
                    data: values,
                    backgroundColor: PLOT_COLORS,
                    {#hoverOffset: 4#}
                    //ackgroundColor: Utils.colors({
                    //   color: Utils.color(0),
                    //  count: 5
                    //}),
                    //data: Utils.numbers({
                    //   count: 5,
                    //  min: 0,
                    // max: 100
                    //}),
                }],
            };

            const chartSpendingPie = new Chart(chartArea, {
                {#type: "pie",#}
                type: 'doughnut',
                data: data,
                options: {
                    animation: false,
                    {#plugins: [ChartDataLabels],#}
                    plugins: {
                        legend: {
                            display: false // This will hide the legend
                        },
                        // Configuration options for the datalabels plugin
                        datalabels: {
                            backgroundColor: function (context) {
                                return context.dataset.backgroundColor;
                            },
                            borderColor: 'white',
                            borderRadius: 25,
                            borderWidth: 2,
                            color: 'white',
                            display: function (context) {
                                let dataset = context.dataset;
                                let count = dataset.data.length;
                                let value = dataset.data[context.dataIndex];
                                return value > count * 1.5;
                            },
                            font: {
                                weight: 'bold'
                            },
                            padding: 6,
                            formatter: Math.round,

                            anchor: 'end',
                            align: 'end',
                            labels: {
                                color: 'blue'
                            }
                        }
                    }
                }
            })


            {#    radius: 0, // Don't show circles on the points.#}
            {#    responsive: true,#}
            {#    scales: {#}
            {#        x: {#}
            {#            display: true,#}
            {#            title: {#}
            {#                display: true,#}
            {#                text: 'Frequency (Hz)'#}
            {#            },#}
            {#            type: FREQ_LOG ? 'logarithmic' : 'linear',#}
            {#            ticks: {#}
            {#                stepSize: 500#}
            {#            }#}
            {#        },#}
            {#        y: {#}
            {#            title: {#}
            {#                display: true,#}
            {#                text: 'Amplitude and phase response'#}
            {#            },#}
            {#            display: true,#}
            {#ticks: {#}
            {#    stepSize: #}
            {##}
            {#        }#}
            {#    },#}
            {#    plugins: {#}
            {#        title: {#}
            {#            display: true,#}
            {#            text: 'Filter response: Amplitude and phase'#}
            {#        }#}
            {#    },#}

        }

        function setupTrendCharts() {
            // https://www.chartjs.org/docs/latest/charts/doughnut.html#doughnut

            {#const config = {#}
            {#    type: 'doughnut',#}
            {#    data: data,#}

            // Set up spending over time.
            getEl('spending-over-time').remove()

            let el = document.createElement("canvas")
            el.setAttribute("id", "spending-over-time")
            getEl("spending-over-time-wrapper").appendChild(el)

            let chartArea = getEl('spending-over-time').getContext('2d')

            let labels = []
            let values = []
            for (let item of SPENDING_OVER_TIME) {
                labels.push(item[0])
                values.push(-item[1])
            }

            let data = {
                labels: labels,
                datasets: [{
                    label: "Spending over time",
                    data: values,
                    backgroundColor: PLOT_COLORS,
                    hoverOffset: 4
                }]
            };

            let chartSpending = new Chart(chartArea, {
                type: 'line',
                data: data,
                options: {
                    animation: false,
                    plugins: {
                        legend: {
                            display: false // This will hide the legend
                        }
                    }
                }
            })

            // todo: DRY with above!

            // Set up net income over time
            getEl('income-over-time').remove()

            el = document.createElement("canvas")
            el.setAttribute("id", "income-over-time")
            getEl("income-over-time-wrapper").appendChild(el)

            chartArea = getEl('income-over-time').getContext('2d')

            labels = []
            values = []
            for (let i=0; i<INCOME_OVER_TIME.length; i++) {
                {#for (item of INCOME_OVER_TIME) {#}
                labels.push(INCOME_OVER_TIME[i][0])
                values.push(INCOME_OVER_TIME[i][1] + SPENDING_OVER_TIME[i][1])
            }

            data = {
                labels: labels,
                datasets: [{
                    label: "Net income over time",
                    data: values,
                    backgroundColor: PLOT_COLORS,
                    hoverOffset: 4
                }]
            };

            let chartIncome = new Chart(chartArea, {
                type: 'line',
                data: data,
                options: {
                    animation: false,
                    plugins: {
                        legend: {
                            display: false // This will hide the legend
                        }
                    }
                }
            })
        }

        function setDatePickerDefaults() {

            // Setup
            const today = new Date();

            // Subtract 30 days
            const thirtyDaysAgo = new Date(today.setDate(today.getDate() - 30));

            // Format the date as "YYYY-MM-DD"
            getEl("start").value = thirtyDaysAgo.toISOString().split('T')[0]
            getEl("end").value = (new Date()).toISOString().split('T')[0]
        }

        function init() {
            setDatePickerDefaults()
            setRange(30)
        }

        init()


    </script>

{% endblock %}