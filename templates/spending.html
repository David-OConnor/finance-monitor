{% extends 'base.html'  %}

{% block head_contents %}
    <title>Finance Monitor: Spending</title>
{% endblock %}

{% block contents %}
    <div class="home-body">
        <h2>Past <span id="days-back">30</span> days</h2>
        <div style="display: flex; align-items: center; flex-wrap: wrap;">
            {#            <form method="post" style="display: flex; align-items: center;">#}
            {#                {% csrf_token %}#}
            <button class="button-general" onclick="setRange(30)">Past 30 days</button>
            <button class="button-general" onclick="setRange(60)">Past 60 days</button>
            <button class="button-general" onclick="setRange(90)">Past 90 days</button>
            <button class="button-general" onclick="setRange(-1)">Custom:</button>

            <h3 style="margin-right: 6px;">Start:</h3>
            <input id="start" type="date" />
            <h3 style="margin-left: 12px; margin-right: 6px;">End:</h3>
            <input id="end" type="date" />
            {#            </form>#}
        </div>


        <div style="display: flex; justify-content: center;">
            {#            <h2 style="margin-right: 40px;">Income: <span  id="income-total">{{ income_total|floatformat:"0g" }}</span></h2>#}
            <h2 style="margin-right: 40px;">Income: <span id="income-total" class="tran-pos"></span></h2>
            {#            <h2>Expenses: <span id="expenses-total">{{ expenses_total|floatformat:"0g" }}</span></h2>#}
            <h2>Expenses: <span id="expenses-total" class="tran-neg"></span></h2>
        </div>

        <div style="display: flex; justify-content: center; flex-wrap: wrap;">
            <div id="plot-wrapper" style="width: 460px; margin-bottom: 40px;">
                <canvas id="plot"></canvas>
            </div>


{#        <div style="display: flex; justify-content: space-evenly">#}

            <div style="display: flex; flex-direction: column; margin-left: 80px; margin-right: 80px;">
                <h2>Spending by category</h2>
                <div id="spending-section">
                    {#                    {% for highlight in highlights.by_cat %}#}
                    {#                        <h4 style="margin-top: 0; margin-bottom: 0;">{{ highlight.0 }}: <span>{{ highlight.1.1|floatformat:"0g" }}</span></h4>#}
                    {#                    {% endfor %}#}
                </div>
            </div>

            <div style="display: flex; flex-direction: column;">
                <h2>Changes, by category</h2>
                <div id="change-section">
                    {#                    {% for change in highlights.cat_changes %}#}
                    {#                        <h4 style="margin-top: 0; margin-bottom: 0;">{{ change.0 }}: <span>{{ change.1|floatformat:"0g" }}</span></h4>#}
                    {#                    {% endfor %}#}
                </div>
            </div>
        </div>


    <div style="display: flex; margin-top: 20px; align-items:  center; flex-direction: column">
        <h2>Spending over time</h2>

            <div id="plot-over-time-wrapper" style="width: 700px; margin-bottom: 40px;">
                <canvas id="plot-over-time"></canvas>
            </div>
    </div>

    <div style="display: flex; margin-top: 20px; align-items:  center; flex-direction: column">
        <h2>Net income over time</h2>

            <div id="income-over-time-wrapper" style="width: 700px; margin-bottom: 40px;">
                <canvas id="income-over-time"></canvas>
            </div>
    </div>

    </div>

    <script src="../static/util.js"></script>
    <script src="../static/js_libs/chart.min.js"></script>

    <script>
        getEl("menu-spending").classList.add("menu-highlighted")

        {# Load template variables into JS. #}

        {#let HIGHLIGHTS = {{ highlights|safe }};#}
        {#let INCOME_TOTAL = {{ income_total|safe }};#}
        {#let EXPENSES_TOTAL = {{ expenses_total|safe }};#}
        let CUSTOM_CATEGORIES = {{custom_categories|safe }};

        let HIGHLIGHTS = {by_cat: []}
        let INCOME_TOTAL = 0
        let EXPENSES_TOTAL = 0
        let SPENDING_OVER_TIME = []
        let INCOME_OVER_TIME = []

        let LOOKBACK = 30

        // If we overrun this color list, it loops back to the top.
        const PLOT_COLORS = [
            'rgb(255, 99, 132)',
            'rgb(54, 162, 235)',
            'rgb(187,255,86)',
            'rgb(86,255,255)',
            'rgb(199,86,255)',
            'rgb(255,137,86)',
            'rgb(255,86,227)',
            'rgb(86,255,204)',
            //
            'rgb(180,71,95)',
            'rgb(36,110,161)',
            'rgb(117,157,54)',
            'rgb(55,166,166)',
            'rgb(131,55,164)',
            'rgb(150,82,51)',
            'rgb(169,56,150)',
            'rgb(52,168,133)',

        ]

        function setRange(daysBack) {
            // Set the date range.

            LOOKBACK = daysBack
            getEl("days-back").textContent = daysBack

            let start, end
            if (daysBack === -1) {
                // auto
                start = getEl("start").value
                end = getEl("end").value
            } else {
                end = 0
                start = daysBack
            }

            const payload = {
                start: start,
                end: end,
            }

            fetch("/load-spending-data", { body: JSON.stringify(payload), ...FETCH_HEADERS_POST })
                .then(result => result.json())
                .then(r => {
                    HIGHLIGHTS = r.highlights
                    INCOME_TOTAL = r.income_total
                    EXPENSES_TOTAL = r.expenses_total
                    SPENDING_OVER_TIME = r.spending_over_time
                    INCOME_OVER_TIME = r.income_over_time

                    console.log(SPENDING_OVER_TIME, "SOT")

                    LOOKBACK = daysBack

                    getEl("income-total").textContent = formatAmount(INCOME_TOTAL, 0)
                    getEl("expenses-total").textContent = formatAmount(EXPENSES_TOTAL, 0)

                    populate()
                    setupPieCharts()
                    setupTrendCharts()
                });
        }

        function populate() {
            let sectionSpending = getEl("spending-section")
            sectionSpending.replaceChildren()

            for (let item of HIGHLIGHTS.by_cat) {
                let amountText = formatAmount(item[1][1])
                amountText = amountText.replace("-", "")

                let h4 = createEl("h4", {}, {marginTop: 0, marginBottom: 0, fontWeight: "normal"}, catDisp(item[0]) + ": ")
                let s = createEl("span", {class: "tran-neutral"},  {}, amountText)
                h4.appendChild(s)
                sectionSpending.appendChild(h4)
            }

            let sectionChanges = getEl("change-section")
            sectionChanges.replaceChildren()
            for (let item of HIGHLIGHTS.cat_changes) {
                let amountText = formatAmount(item[1])
                if (item[1] > 0) {
                    amountText = "+" + amountText
                }

                let h4 = createEl("h4", {}, {marginTop: 0, marginBottom: 0, fontWeight: "normal"}, catDisp(item[0]) + ": ")
                let s = createEl("span", {class: "tran-neutral"},  {}, amountText)
                h4.appendChild(s)
                sectionChanges.appendChild(h4)
            }
        }

        function updateData() {

        }

        function setupPieCharts() {
            // https://www.chartjs.org/docs/latest/charts/doughnut.html#doughnut

            {#const config = {#}
            {#    type: 'doughnut',#}
            {#    data: data,#}

            getEl('plot').remove()

            let el = document.createElement("canvas")
            el.setAttribute("id", "plot")
            getEl("plot-wrapper").appendChild(el)

            let chartArea = getEl('plot').getContext('2d')

            let labels = []
            let values = []
            for (let item of HIGHLIGHTS.by_cat) {
                labels.push(catDisp(item[0]))
                values.push(item[1][1])
            }

            const data = {
                labels: labels,
                datasets: [{
                    label: "Spending, by category",
                    data: values,
                    backgroundColor: PLOT_COLORS,
                    hoverOffset: 4
                }]
            };

            const myChart = new Chart(chartArea, {
                {#type: 'pie',#}
                type: 'doughnut',
                data: data,
                options: {}
            })
            {#    radius: 0, // Don't show circles on the points.#}
            {#    responsive: true,#}
            {#    scales: {#}
            {#        x: {#}
            {#            display: true,#}
            {#            title: {#}
            {#                display: true,#}
            {#                text: 'Frequency (Hz)'#}
            {#            },#}
            {#            type: FREQ_LOG ? 'logarithmic' : 'linear',#}
            {#            ticks: {#}
            {#                stepSize: 500#}
            {#            }#}
            {#        },#}
            {#        y: {#}
            {#            title: {#}
            {#                display: true,#}
            {#                text: 'Amplitude and phase response'#}
            {#            },#}
            {#            display: true,#}
            {#ticks: {#}
            {#    stepSize: #}
            {##}
            {#        }#}
            {#    },#}
            {#    plugins: {#}
            {#        title: {#}
            {#            display: true,#}
            {#            text: 'Filter response: Amplitude and phase'#}
            {#        }#}
            {#    },#}

        }

        function setupTrendCharts() {
            // https://www.chartjs.org/docs/latest/charts/doughnut.html#doughnut

            {#const config = {#}
            {#    type: 'doughnut',#}
            {#    data: data,#}

            // Set up spending over time.
            getEl('plot-over-time').remove()

            let el = document.createElement("canvas")
            el.setAttribute("id", "plot-over-time")
            getEl("plot-over-time-wrapper").appendChild(el)

            let chartArea = getEl('plot-over-time').getContext('2d')

            let labels = []
            let values = []
            for (let item of SPENDING_OVER_TIME) {
                labels.push(item[0])
                values.push(item[1])
            }

            let data = {
                labels: labels,
                datasets: [{
                    label: "Spending over time",
                    data: values,
                    backgroundColor: PLOT_COLORS,
                    hoverOffset: 4
                }]
            };

            let myChart = new Chart(chartArea, {
                type: 'line',
                data: data,
                options: {}
            })
            
            // todo: DRY with above!
            
            // Set up net income over time
            getEl('income-over-time').remove()

            el = document.createElement("canvas")
            el.setAttribute("id", "income-over-time")
            getEl("income-over-time-wrapper").appendChild(el)

            chartArea = getEl('income-over-time').getContext('2d')

            labels = []
            values = []
            for (let i=0; i<INCOME_OVER_TIME.length; i++) {
            {#for (item of INCOME_OVER_TIME) {#}
                labels.push(INCOME_OVER_TIME[i][0])
                console.log("Income in this period: ", INCOME_OVER_TIME[i], "Spending: ", SPENDING_OVER_TIME[i])
                values.push(INCOME_OVER_TIME[i][1] + SPENDING_OVER_TIME[i][1])
            }

            data = {
                labels: labels,
                datasets: [{
                    label: "Net income over time",
                    data: values,
                    backgroundColor: PLOT_COLORS,
                    hoverOffset: 4
                }]
            };

            myChart = new Chart(chartArea, {
                type: 'line',
                data: data,
                options: {}
            })
        }

        function init() {
            setRange(30)
        }

        init()


    </script>

{% endblock %}