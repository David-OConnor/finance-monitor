{% extends 'base.html'  %}

{% block head_contents %}
    <title>Finance Monitor: Settings</title>
{% endblock %}

{% block contents %}

    <div class="home-body">

        <h2 style="text-align: center">Categorization rules</h2>
        <div style="display: flex; flex-direction: column; align-items: center">

            <button class="button-general" onclick="saveRules()" style="margin-bottom: 12px;">Save rules</button>

            {% for rule in rules %}
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <input
                            id="rule-descrip-{{ rule.id }}"
                            style="width: 200px; margin-right: 10px;"
                            value="{{ rule.description }}"
                            oninput="updateRule({{ rule.id }})" />

                    <h4 style="margin-top: 0; margin-bottom: 0">➡</h4>
                    <select
                            id="rule-category-{{ rule.id }}"
                            style="margin-left: 10px;">
                        {{ rule.category }}
                    </select>
                </div>
            {% endfor %}
        </div>

        <h2 style="text-align: center; margin-top: 60px;">Import and export transactions</h2>

        <div style="display: flex; justify-content: center;">
            {#            Import / export form #}
            <form
                    id="import-form"
                    method="post"
                    enctype="multipart/form-data"
                    {#                    collapse vis a/r#}
                    style="display: flex; align-items: center; visibility: visible;"
            >
                {% csrf_token %}
                {#                <input#}
                {#                    style="color: black; background-color: #aaaaaa; height: 38px;"#}
                {#                    type="file"#}
                {#                    accept="text/csv"#}
                {#                />#}
                <input type="file" name="file" required id="id_file"
                       style="color: black; background-color: #aaaaaa; height: 38px;">
            </form>

            <button id="import-start" class="button-general">Import from Mint ↑</button>
            {#            Have a button show the import dialog#}
            <button id="export" class="button-general">Export ↓</button>
        </div>

        <h2 style="text-align: center; margin-top: 60px; margin-bottom: 0;">Change password</h2>

        {% if password_change %}
            {% if password_change_success %}
                <h2 style="color: green; text-align: center">
                    Password successfully changed
                </h2>
            {% else %}
                <h2 style="color: #8d4a1f; text-align: center">
                    Password change failed; please try again.
                </h2>
            {% endif %}
        {% endif %}

        <div class="form-block" style="display: flex; justify-content: center;">
            <form
                    method="post"
                    style="display: flex; flex-direction: column; align-items: center; margin-top: 0;">

                {#                todo: C+P with little change from login and reset confirm!#}
                {% csrf_token %}

                <label for="id_new_password1" style="margin-top: 32px;">Password:</label>
                <input
                        type="password"
                        name="new_password1"
                        autocomplete="new-password"
                        required aria-describedby="id_password1_helptext"
                        id="id_password1"
                        style="width: 180px; margin-bottom: 20px;"
                >

                <label for="id_new_password2">Password confirmation:</label>
                <input
                        type="password"
                        name="new_password2"
                        autocomplete="new-password"
                        required aria-describedby="id_new_password2_helptext"
                        id="id_password2"
                        style="width: 180px;"
                >

                <span class="helptext" id="id_new_password1_helptext">
                    <ul>
{#                        <li>Your password can’t be too similar to your other personal information.</li>#}
                        <li>Your password must contain at least 8 characters.</li>
                        <li>Your password can’t be a commonly used password.</li><li>Your password can’t be entirely numeric.</li>
                    </ul>
                </span>

                {#                <span class="helptext" id="id_password2_helptext">Enter the same password as before, for verification.</span>#}

                <button
                        class="button-general"
                        type="submit"
                        style="margin-top: 32px; width: 180px; margin-bottom: 40px;"
                >Change your password</button>
            </form>
        </div>
    </div>

    <script src="../static/util.js"></script>
    <script>
        document.getElementById("menu-settings").classList.add("menu-highlighted")

        document.getElementById('export').addEventListener('click', function() {
            window.location.href = '/export'
        })

        let rulesUpdated = {}

        {#Set up the import start#}
        const importStart = document.getElementById('import-start')
        importStart.addEventListener('click', function() {
            {#importStart.#}
            const importForm = document.getElementById("import-form")
            if (importForm.style.visibility === "collapse") {
                importForm.style.visibility = "visible"
                importStart.style.visibility = "collapse"
                importStart.textContent = "Cancel import"
            } else {
                importForm.style.visibility = "collapse"
                importStart.textContent = "Import ↑"
            }
            //
        })

        function updateRule(id) {
            rulesUpdated[id] = {
                descrip: document.getElementById("rule-descrip-" + id.toString()).value,
                category: parseInt(document.getElementById("rule-category-" + id.toString()).value),
            }

            console.log("Updated: ", rulesUpdated)
        }

        function saveRules() {

        }

    </script>

{% endblock %}